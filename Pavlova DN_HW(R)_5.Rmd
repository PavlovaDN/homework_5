---
title: "R_HW_5"
author: "Pavlova"
output: html_document
---

### ДОМАШНЯЯ РАБОТА №5

Домашнее задание 5 Тема: построение регрессионных моделей и анализ выживаемости.

Цель: научиться пользоваться основными методами регрессионного анализа, разобраться с принципами анализа выживаемости.

Описание ДЗ Для выполнения первых двух заданий загрузите датасет Breast Cancer Wisconsin.

В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

Выполните перечисленные задания.

Задание 1 (2 балла) Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# библиотеки
library(ggplot2)
library(dplyr)
library(car)
library(pROC)
library(survival)
library(survminer)
```

```{r}
# загрузка датасета
data <- read.csv("C:/Users/admin/Desktop/DS/R/hw5/wisconsin_breast_cancer.csv")
```

```{r}
str(data)
```

```{r}
str(data$diagnosis)
```

```{r}
# так как переменная diagnosis представляет собой категориальную переменную, то преоьразуем её в фактор
# Преобразование столбца diagnosis в фактор
data$diagnosis <- as.factor(data$diagnosis)

```

```{r}
#проверка пропущенных значений
colSums(is.na(data[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))
```

пропущенных значений нет. Так как значения данных переменных непрерывные числовые, то следует использовать линейную регрессию. Формулируем гипотезы: H0 - не существует линейная зависимость между переменными; Ha - существует линейная зависимость между переменными.

```{r}
# Подготовка данных
data$diagnosis <- as.factor(data$diagnosis)

# Выбор необходимых столбцов для модели
selected_columns1 <- c("radius_mean", "area_mean")
selected_columns2 <- c("radius_mean", "perimeter_mean")
selected_columns3 <- c("radius_mean", "symmetry_mean")

# Построение регрессионных моделей
model1 <- lm(radius_mean ~ ., data = data[selected_columns1])
model2 <- lm(radius_mean ~ ., data = data[selected_columns2])
model3 <- lm(radius_mean ~ ., data = data[selected_columns3])

# Вывод информации о моделях
summary(model1)
summary(model2)
summary(model3)

# Построение графиков
par(mfrow = c(2, 2)) # Устанавливаем макет графиков (2 строки и 2 столбца)
plot(data$radius_mean, data$area_mean, xlab = "Radius Mean", ylab = "Area Mean", main = "Regression Plot 1")
abline(model1, col = "red")

plot(data$radius_mean, data$perimeter_mean, xlab = "Radius Mean", ylab = "Perimeter Mean", main = "Regression Plot 2")
abline(model2, col = "blue")

plot(data$radius_mean, data$symmetry_mean, xlab = "Radius Mean", ylab = "Symmetry Mean", main = "Regression Plot 3")
abline(model3, col = "green")

```

Визуально можно сказать о наличии прямой линейной зависимости среднего радиуса и средней площади, а также о наличии данной зависимости между средним радиусом и среднеего периметра опухоли (нулевая гипотеза следует отвергнуть). Также визуализация показывает отсутствие линейной зависимости между средним радиусом опухоли и вредней симметричности (нулевую гипотезу следует принять).

Также, модели 1 и 2 имеют высокое значение R-квадрат и низкое значение стандартная ошибка остатков, что указывает на хорошее качество модели. В модели 3 R-квадрат низкий, а стандартная ошибка остатков высока, что указывает на то, что эта модель может быть менее надежной для прогнозирования радиуса опухоли на основе симметрии.

```{r}
# Оценка нормальности распределения остатков с помощью теста Шапиро-Уилка
shapiro.test(residuals(model1))
shapiro.test(residuals(model2))
shapiro.test(residuals(model3))
```

Результаты теста Шапиро-Уилка для остатков каждой модели указывают на то, что остатки не распределены нормально. Это подтверждается низкими значениями p-значений, которые существенно меньше стандартного уровня значимости при альфа=0.05.

Для линейной модели важно также оценить гомоскедативность и мультиколлинерность остатков.

```{r}
# Тест Уайта на гомоскедастичность

ncvTest(model1)
ncvTest(model2)
ncvTest(model3)



```

Видно несоблюдения постоянства дисперсии для всех трех моделей в связи с низкими значениями p-value (нет гомогенности).

Можно построить графики независимых переменных и оценить мультиколлинеарность:

```{r}
data %>%
    ggplot(aes(x = perimeter_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего периметра и средеей симметричности",
      x = "Средняя симметричности опухоли",
      y = "Средний периметр опухоли")
```

```{r}
data %>%
    ggplot(aes(x = area_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и средней симметричности опухоли",
      x = "Средняя площадь опухоли",
      y = "Средняя симметричность опухоли") 
```

```{r}
data %>%
    ggplot(aes(x = area_mean, y = perimeter_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и среднего периметра опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний периметр опухоли")

```

При визуализации видна сильная корреляция между средней площадью опухоли и среднего периметра, что может говорить о мультиколлинеарности.

### Задание 2 (2 балла)

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

Формулируем гипотезы: H0 - нет статистической значимости возникновения злокачественной опухоли от всех трех факторов. Ha - есть статистической значимости возникновения злокачественной опухоли от всех трех факторов.

Так как зависимая переменная может иметь только два значения, т.е. она явлется категориальной, то следует построить биномиальную логистичекую регрессию.

```{r}
# Преобразование значений диагноза
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)

# Модель с одним фактором (средний радиус)
model1 <- glm(diagnosis ~ radius_mean, data = data, family = binomial)

# График зависимости диагноза от среднего радиуса
plot(data$radius_mean, data$diagnosis, xlab = "Средний радиус", ylab = "Диагноз", main = "Зависимость диагноза от среднего радиуса")
abline(model1, col = "red")

# Модель с тремя факторами (средний радиус, средняя площадь, средняя текстура)
model2 <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = binomial)

# Вывод результатов модели
summary(model2)
```

p-value более 0.05 и не является статистически значимыми на уровне значимости альфа=0.05, за исключением средней текстуры (texture_mean).Таким образом, средняя текстура опухоли (texture_mean) оказывает статистически значимое влияние на вероятность возникновения злокачественной опухоли, в то время как средний радиус и средняя площадь не оказывают статистически значимого влияния на диагноз при выбранном уровне значимости.

Значение AIC (Akaike Information Criterion) равно 296.81, что позволяет сравнивать данную модель с другими моделями на основе AIC. Чем меньше значение AIC, тем лучше модель. Можно попробовать посторить многочленную лог.регрессию.

Для визуализации результатов бинарной логистической регрессии можно использовать построение ROC-кривой (Receiver Operating Characteristic curve) и вычисление площади под ROC-кривой (AUC-ROC).

```{r}
# Предсказание вероятностей класса 1
predicted_probabilities <- predict(model2, type = "response")

# Создание объекта 'roc' для вычисления ROC-кривой
roc_curve <- roc(data$diagnosis, predicted_probabilities)

# Построение ROC-кривой
plot(roc_curve, main = "ROC Curve", col = "blue", lwd = 2)

# Добавление линии, представляющей случайную модель
lines(x = c(0, 1), y = c(0, 1), col = "black", lty = 2)

# Вычисление AUC-ROC:
auc_value <- auc(roc_curve)
legend("bottomright", legend = paste("AUC =", round(auc_value, 2)), col = "blue", lwd = 1, bty = "n")

```

Высокое значение AUC (0.95) в логистической регрессии указывает на очень хорошую модель логистической регрессии.

```{r}
# Визуализация кривой биномиальной логистической регрессии: 
data %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среднего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = binomial)) +
  theme_bw()
```

```{r}
data %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и средней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
data %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среднего значения текстуры опухоли",
      x = "Средняя текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

В связи с тем,что текстура опухоли влияет на вероятность возникновения злокачественной опухоли, то есть строение опухоли имеет статистически значимую связь со сзлокачественным образованием и мы можем отвергнуть нулевую гипотезу.

### Задание 3 (6 балла)

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

-   inst: код учреждения;
-   time: время выживаемости в днях; status: 1 = цензурирование, 2 = смерть;
-   age: возраст в годах;
-   sex: мужской = 1, женский = 2;
-   ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
-   meal.cal: калории потребляемой пищи;
-   wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним).

Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты. Постройте график кумулятивной функции рисков (cumulative hazard function) для пола.

Проинтерпретируйте график.

С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость.

Что вы можете сказать о полученных результатах?

```{r}
#загружаем датасет из пакета survival
data_lung <- survival::lung
str(data_lung)
```

```{r}
data_lung$event <- ifelse(lung$status == 2, 1, 0)

```

```{r}
#Распределение времени выживаемости

ggplot(data_lung, aes(x = time, y = event)) +
  geom_point() +
  labs(x = "Время выживаемости (дни)", y = "Смерть (1) / Цензурирование (0)")

```


```{r}
# Кривые выживаемости по полу:

km <- survfit(Surv(time, status) ~ sex, data = data_lung)

# Отобразим модель на графике
ggsurvplot(km, data = data_lung, risk.table = TRUE)

```
На графике можно видеть, что выживаемость у женщин выше чем у мужчин.

Сформулируем гипотезы:
Н0 - Отсутствует статистическая значимость в выживаемости между людьми разного пола.

На - Существует статистическая значимость в выживаемости между людьми разного пола.
При альфа=0.05
Проведём лог-ранг тест.
```{r}
survdiff_lung <- survdiff(Surv(time, status) ~ sex, data = data_lung)
survdiff_lung
```
P-value значение (0.001) меньше, чем уровень значимости 0.05.Это означает, что есть статистическая значимость различий, в выживаемости мужчин и женщин. 
```{r}
# График cumulative hazard function:
ggsurvplot(km, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```

Согласно графику кумулятивного риска для пола, риск наступления исхода выше у мужчин. Также можно отметить, что постепенно риск у мужчин растёт.

Постоим регрессию Кокса, чтобы оценить влияние пола на выживаемость.
```{r}
# Создадим Cox-регрессию
Cox <- coxph(Surv(time, status) ~ sex, data = data_lung)
Cox

# Построим график
ggsurvplot(surv_fit(Cox, data = data_lung), data = data_lung)

```
Согласно графику число наблюдений уменьшается, а p_value=0.136, что больше уровня значимости, а следовательно показывает наличие статистической значимости  в зависимости от пола. coef=-0.5310, что говорит, что риск у женщин ниже чем у мужчин на 0.5880 (значение exp(coef)),



